---
title: " "
output:
  html_document:
    css: "../theme/yimby_mel.css"
    title: "Missing Middle zoning"
params:
  area: "Small area"
---

```{r setup, include=FALSE}

knitr::opts_chunk$set(message = FALSE, warning = FALSE, error = FALSE, echo = FALSE, dpi = 300,fig.width = 7, fig.height = 4)
knitr::opts_knit$set(root.dir= '../')   

parcels <- prettyNum(nrow(df_lga_props),big.mark = ",")

fois <- df_lga_props %>% 
  filter(feature_preventing_development) %>% 
  nrow()%>% 
  prettyNum(big.mark = ",")
  
bad_zoning <- df_lga_props %>% 
    filter(!feature_preventing_development) %>% 
  group_by(zoning_permits_housing) %>% 
  summarise(n=n()) %>% 
  filter(zoning_permits_housing == "Housing not generally permitted") %>% 
  pull(n) %>% 
  prettyNum(big.mark = ",")

already_developed <- df_lga_props %>% 
  filter(zoning_permits_housing == "Housing permitted",
         !feature_preventing_development,
         dwellings_est>1) %>%
  nrow()%>% 
  prettyNum(big.mark = ",")


df_lga_useful_props_num <-  prettyNum(nrow(df_lga_useful_props),big.mark = ",")

mcg_size <- 20000 

# Corrected function to generate a button with customizable text and link
generateButton <- function(text, link) {
  buttonHTML <- paste0('<div class="button-row"><div style="opacity: 1; transform: translate3d(0px, 0px, 0px) scale3d(1, 1, 1) rotateX(0deg) rotateY(0deg) rotateZ(0deg) skew(0deg); transform-style: preserve-3d;" class="button-wrapper"><a href="', link, '" class="button-fullwidth-2 w-inline-block"><div style="width: 0%; height: 2px;" class="bottom-line-2"></div><div style="height: 0%; width: 2px;" class="left-line-2"></div><div style="width: 0%; height: 2px;" class="top-line-2"></div><div style="height: 0%; width: 2px;" class="right-line-2"></div><div style="height: 0%; width: 538.617px;" class="overlay-colr-button-2"></div><div style="color: rgb(0, 0, 0);" class="button-text">', text, '</div></a></div></div>')
  cat(buttonHTML)
}


```

![](../atlas/mel_missing_middle.png)

##  {.tabset}


The answer to the housing supply shortage will not be found in this handful of
designated activity centres and precincts. `r area_name` needs to do its bit by delivering
beautiful mid-rise homes near every one of its heavy rail stops. 

Through broad transit-oriented upzoning and
development, `r area_name` can
deliver housing abundance and provide more
housing choices to all current and future residents across the entirety of the city. This will
fulfil the original goal of Plan Melbourne creating a vast array of 20-minute neighbourhoods,
rather than a small number of scattered activity centres.

YIMBY Melbourne's [Missing Middle](https://assets-global.website-files.com/64a530aa67ffbab04c9c39ab/652284ad6a63b8b3ab424966_Missing-Middle-Report.pdf) report recommendeds the introduction
of a new "Missing Middle" Zone which:

1. Implements a default maximum height of
21 metres and 6 storeys, an increase from
the RGZâ€™s current 4-storey default.
2. Expands non-residential land uses to
include a wider range of neighbourhood
services & amenities.
3. Reduces mandatory parking minimums to 0.
4. Exempts from notice and review developments
of any total value containing at
least 10% public or community housing
in perpetuity.


```{r }


mm_number <- df_lga_useful_props %>% filter(zone_short_mm == "Missing middle") %>% nrow() %>% prettyNum(big.mark = ",")
rgz_number <- df_lga_useful_props %>% filter(zone_short_mm == "Residential growth") %>% nrow() %>% prettyNum(big.mark = ",")
grz_number <- df_lga_useful_props %>% filter(zone_short_mm == "General residential") %>% nrow() %>% prettyNum(big.mark = ",")


```

In `r area_name`, `r mm_number` properties would be up-zoned to Missing Middle, providing a Parisian like density near transit. A further `r rgz_number` properties will be rezoned
to from General Residential to Residential Growth, and `r grz_number` from Neighbourhood Residential to General Residential. 

Broad upzoning is needed across existing suburbs so that there is more land available to build homes for our children to live in. 
If only a few areas are rezoned, then developers will be able to buy up that land and withhold supply. 
Upzoning all land removes the power developers have to speculate, lowering the cost of housing for all.


### `r area_name`'s new zoning map

There are some errors on here where land is zoned "civic" where it shouldn't be, but if you find anymore please message on the discord!!! 

```{r}
make_map(sf_lga_props,"category_new")

```




### Existing zoning
```{r}
make_map(sf_lga_props,"category")

```



## More zoned capacity for homes in `r params$area`

```{r}
zoned_capacity_x <- lga_summary %>% 
  mutate( change_to_zoned_capacity = paste0(round(change_to_zoned_capacity,1),"x")) %>% 
  pull(change_to_zoned_capacity)


```

There are `r parcels` parcels of land in `r params$area`. But not every piece of land can have housing on it. Of these parcels, `r fois` are on civic land like schools, hospitals, or train stations where development is challenging. Another `r bad_zoning` are in zones that do not development. Finally `r already_developed` properties have already been developed with more than 1 unit, making re-development difficult. 

That leaves `r df_lga_useful_props_num` that are available for development. The size of these lots is `r prettyNum(sum(df_lga_useful_props$lot_size),big.mark = ",")` square meters, or `r round(as.numeric(sum(df_lga_useful_props$lot_size))/mcg_size)` MCGs worth of space to build housing. 

Under existing zoning, the city of Yarra has an estimated zoned capacity of `r prettyNum(round(lga_summary$zoned_capacity,-3), big.mark = ",")`. 
That means that if every plot of land was built up to the maximum possible density zoning allows, this many new homes could be built. 
But it's impractical to think that we would ever build to our zoned capacity. Some homes are heritage listed, some perform vital commercial functions,
while many other people love their homes
and would rather not sell to developers. 

When zoned capacity is only just higher than the number of homes we need to build, it gives land speculators an advantage because they control the only land that can be built on. 

YIMBY Melbourne's plan for `r area_name` increases its zoned capacity by `r zoned_capacity_x`, to `r prettyNum(round(lga_summary$mm_zoned_capacity,-3), big.mark = ",")` -  giving more opportunity for Melbourne to achieve Missing Middle density. 

## Housing targets for `r params$area` 

Even though there are `r prettyNum(round(lga_summary$mm_zoned_capacity,-3), big.mark = ",")` possible units that could be built in `r area_name`, it's impossible for them to be built 
all at once or even at all. For each lot in `r area_name`, YIMBY Melbourne has calcualted whether it would be profitable to build Missing Middle housing based on current
local house values, apartment prices and construction costs. We estimate that around `r prettyNum(round(lga_summary$profitable_apartments,-3), big.mark = ",")` units could potentially
be built profitably in `r area_name`. 

To meet the statewide target of 80,000 new homes per year (56,000 in established areas), `r area_name` must build units proportionate to the `r prettyNum(round(sum(lga_zoning_numbers$profitable_apartments),-4), big.mark = ",")` units that are profitable across all of Melbourne's Middle, which amounts to a target of **`r prettyNum(round(lga_summary$mm_target,-3), big.mark = ",")`** units built each year. This figure is in addition to homes that would be built as part of any rezoning process such as through Fishermans' Bend or the Suburban Rail Loop precincts. 


## Without missing middle `r params$area` is falling behind


`r params$area` needs Missing Middle zoning, because it is not keeping up with population growth. 
While there has been some housing construction, many homes have more bedrooms free than ever before as kids move out of home. The total number of homes is struggling to keep up with Melbourne's evolving housing needs. 

```{r}

#source("R/import_lga_pop_data.R")

mel_total <- lga_pop_change_importer(area_name, type = "population")


lga_change <- mel_total %>% 
  filter(year == 2021,
         lga_name_2021 == area_name) %>%
  pull(change)

mel_change <- mel_total %>% 
  filter(year == 2021,
         lga_name_2021 == "All of Melbourne") %>%
  pull(change)


  
change_ratio <- lga_change/mel_change

## TODO - get PT stops per LGA. 

text_on_growth <- case_when(change_ratio >.9 ~ paste0(params$area, " has been building housing, but cannot rest on its laurels."),
                            change_ratio >.7 ~ paste0(params$area, " has been building some housing, but it is still barely keeping up with the average for Melbourne."),
                            T ~ paste0(params$area, " is falling well behind the average for new housing in Melbourne.")
)

```


`r text_on_growth` It has amazing public transport, and it needs to do more to ensure that housing is abundant. 

```{r}
mel_total %>%
  ggplot(aes( x= year, y = change,
              colour = lga_name_2021))+
  geom_line(stat = "identity",linewidth = 1)+
  theme_yimby_mel_caption(caption = "source: ABS. ",
                          text_size = "small",
                          plot_type = "line",
                          colour_scale = "c")+
  labs(title = paste("Growth in homes for",area_name,"compared to the rest of Melbourne\n
                     GRAPH HAS ERROR TODO:FIX"),
       subtitle = "Growth in census dwellings since 2006",
       labs = element_blank(),
       colour = "Area",
       x = element_blank(),
       y = element_blank())+
  scale_y_continuous(labels = scales::percent_format())


```



## `r area_name` is falling behind because zoning is too restrictive. {.tabset}

The reason `r area_name` is not building enough housing is because there are not enough areas where housing can be built. The graph below shows that the majority of land in `r area_name` is locked away, preventing Missing Middle Density.

### By number of lots

```{r}

dwellings_by_type <- df_lga_useful_props %>%
  group_by(category) %>% 
  summarise(n = n(),
            lot_size = sum(lot_size),
            .groups = "drop") %>% 
  group_by(category) %>% 
  mutate(n_total = sum(n),
         lot_size_total = sum(lot_size))  %>% 
  ungroup() 

dwellings_by_type %>% 
  mutate(category = fct_reorder(category,n_total)) %>% 
  ggplot(aes(x = category, 
             y = n))+
  coord_flip()+ 
  geom_bar(stat = "identity")+
  theme_yimby_mel_caption(text_size = "small",plot_type = "bar",colour_scale = "light_dark") +
  labs(x = element_blank(),
       title = paste0("Land in ",area_name," by type"),
       y = "Number of properties",
       fill = "Heritage status")

```

### By total area

```{r by total area}
dwellings_by_type %>% 
    mutate(category = fct_reorder(category,lot_size_total)) %>%
  ggplot(aes(x = category, 
             y = lot_size_total))+
  coord_flip()+ 
  geom_bar(stat = "identity")+
  theme_yimby_mel_caption(text_size = "small",plot_type = "bar",colour_scale = "light_dark") +
  labs(x = element_blank(),
       title = paste0("Land in ",area_name," by type"),
       y = "Area (sqm)",
       fill = "Heritage status")+
  scale_y_continuous(labels = scales::number_format(big.mark = ","))

```

### Table


```{r}
library(kableExtra)
library(gt)

dwellings_by_type_w_heritage <- df_lga_useful_props %>%
  group_by(category,heritage) %>% 
  summarise(n = n(),
            lot_size = sum(lot_size),
            .groups = "drop") %>% 
  group_by(category) %>% 
  mutate(n_total = sum(n),
         lot_size_total = sum(lot_size))  %>% 
  ungroup() %>% 
  mutate(heritage = if_else(heritage,
                            "Subject to heritage controls",
                            "Free from heritage"))

types_zonning <- df_lga_useful_props %>% 
  group_by(heritage) %>% 
  summarise(n = n(),
            lot_size = sum(lot_size)) %>% 
  mutate(category = "Total")%>% 
  mutate(heritage = if_else(heritage,
                            "Subject to heritage controls",
                            "Free from heritage"))


types_total_new <- df_lga_useful_props %>%
  filter(!feature_preventing_development,
         zoning_permits_housing == "Housing permitted",
         dwellings_est < 2) %>% 
  group_by(heritage) %>% 
  summarise(n = n(),
            lot_size = sum(lot_size),
            .groups = "drop") %>% 
  mutate(heritage = if_else(heritage,
                            "Subject to heritage controls",
                            "Free from heritage"),
         category = "Total where new housing can be built") 

dwellings_by_type_w_heritage %>% 
  bind_rows(types_zonning) %>% 
  bind_rows(types_total_new) %>% 
  group_by(category) %>% 
  mutate(`Share of properties that are heritage` = paste0(round(100*n/sum(n)),"%"),
         `Share of land that is heritage` =  paste0(round(100*lot_size/sum(lot_size)),"%")
         ) %>% 
  rename(`Number of properties` = n,
         `Area (sqm)` = lot_size,
         ` ` = heritage) %>% 
  select(-n_total,-lot_size_total) %>% 
    gt()  %>% 
  fmt_number(decimals = 0)

  

```




## Heritage should not be a barrier to housing abudance 
```{r}

heritage_no <- df_lga_useful_props %>% 
  filter(profitable_apartments>0) %>% 
  summarise(apartments_affected_by_heritage = paste0(round(100*weighted.mean(heritage,profitable_apartments)),"%")) %>% 
  pull(apartments_affected_by_heritage) 

```
Of the `r prettyNum(round(lga_summary$profitable_apartments,-4), big.mark = ",")` potentially profitable apartments that could be built in `r area_name`, `r heritage_no` of these potential future homes are on lots subject to heritage controls. 

If there is too much heritage in `r area_name`, it could potentially affect `r area_name`s ability to meet its housing targets. 

If heritage is a barrier to growth then `r area_name` has three options:
1. Adjust heritage controls to allow more density on heritage land
2. Remove heritage controls from low-value properties
3. Pay compensation to local councils who are doing their bit to contribute to solving the housing crisis. 


```{r conditional-include, echo=FALSE, results='asis'}

# Conditionally include the R Markdown file
if(area_name == "Melbourne") {
  
  original_wd <- getwd()
  res <-knitr::knit_child('rmd/mel_specific_render.Rmd', quiet = TRUE,options  = c("root.dir" = original_wd))
  cat(res)
  


}

```

```{r results='asis'}
cat('<div class="button-row">')

lga_html <- paste0("https://yimby-mel.s3.ap-southeast-2.amazonaws.com/index.html")

generateButton("Back to Missing Middle zoning for all of Melbourne",lga_html)
cat('</div>')
```


## APPENDIX - ? delete? Lot sizes in Yarra {.tabset}

Larger lots can be easier to develop, but Melbourne has been sucssessful in developing even on small lots

### By number of lots

```{r cars}


df_lga_props %>%
  ggplot() + 
  geom_density_ridges(aes(x = lot_size, 
                     fill = heritage_nice,
                     group = paste0(type_short,heritage),
                     y = type_short,
                     weight = lot_size
                     ),
                     alpha = .8) +
  xlim(0,2000)+
  theme_yimby_mel_caption(text_size = "small",plot_type = "bar",colour_scale = "light_dark") +
  labs(title = paste0("Land in ",params$area," by size of each lot"),
       subtitle = "Height represents the number of lots of each size",
       fill = "Heritage",
      x = "Size of individual lots",
      y = element_blank())

```

### By area

```{r }

 df_lga_props[rep(seq_along(round(as.numeric(df_lga_props$lot_size/50))), round(as.numeric(df_lga_props$lot_size/50))), ] %>%
  mutate(group_name = paste0(type_short,heritage)) %>%
  ggplot() + 
  geom_density_ridges(aes(x = lot_size, 
                     fill = heritage_nice,
                     group = group_name,
                     y = type_short,
                     ),
                     alpha = .8) +
  xlim(0,2000) +
  theme_yimby_mel_caption(text_size = "small",
                          plot_type = "bar",
                          colour_scale = "light_dark") +
  labs(title = paste0("Land in ",params$area," by size of each lot"),
      subtitle = "Height represents the total area taken up by lots of a given lot size",
       fill = "Heritage",
      x = "Size of individual lots",
      y = element_blank())


```


