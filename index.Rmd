--- 
title: "Missing Middle Housing Targets"
author: "YIMBY Melbourne"
date: "`r Sys.Date()`"
site: bookdown::bookdown_site
url: https://targets.yimby.melbourne/
documentclass: book
bibliography: [book.bib, packages.bib]
# url: https://targets.yimby.melbourne/
# cover-image: path to the social sharing image like images/cover.jpg
description: |
  Melbourne's planning system is broken. We need evidence-driven 
  and well-enforced housing targets in order to fix this ongoing crisis.
link-citations: yes
# github-repo: rstudio/bookdown-demo
output:
  includes:
    in_header: header.html
  
---
# Missing Middle Housing Targets

```{r setup, include=FALSE}

knitr::opts_chunk$set(message = FALSE, warning = FALSE, error = FALSE, echo = FALSE, dpi = 300,fig.width = 7, fig.height = 4)
#knitr::opts_knit$set(root.dir= '../')   
knitr::opts_chunk$set(dev.args=list(bg='transparent'))
knitr::opts_chunk$set(dev = "ragg_png")

# Corrected function to generate a button with customizable text and link
generateButton <- function(text, link) {
  buttonHTML <- paste0('<div class="button-row"><div style="opacity: 1; transform: translate3d(0px, 0px, 0px) scale3d(1, 1, 1) rotateX(0deg) rotateY(0deg) rotateZ(0deg) skew(0deg); transform-style: preserve-3d;" class="button-wrapper"><a href="', link, '" class="button-fullwidth-2 w-inline-block"><div style="width: 0%; height: 2px;" class="bottom-line-2"></div><div style="height: 0%; width: 2px;" class="left-line-2"></div><div style="width: 0%; height: 2px;" class="top-line-2"></div><div style="height: 0%; width: 2px;" class="right-line-2"></div><div style="height: 0%; width: 538.617px;" class="overlay-colr-button-2"></div><div style="color: rgb(0, 0, 0);" class="button-text">', text, '</div></a></div></div>')
  cat(buttonHTML)
}


all_zoned_numbers <- lga_zoning_numbers %>% summarise(across(is.numeric, sum))

mm_zoned_capacity <- all_zoned_numbers %>% pull(mm_zoned_capacity) 
total_zoned_capacity <- prettyNum(round(mm_zoned_capacity,-4),big.mark = ",") 

mm_zone_change <- all_zoned_numbers$mm_zoned_capacity/all_zoned_numbers$zoned_capacity

multiplier <- paste0(round(mm_zone_change,1),"x")

```

Melbourne is growing. Our city's urgent need for more homes is clear to all Victorians. And yet most of the policy implemented to-date has been edge-tinkering: granny flats, Future Homes, and the scattered beginnings of outer-urban activity centres.

Since the introduction of [Plan Melbourne](https://www.planning.vic.gov.au/guides-and-resources/strategies-and-initiatives/plan-melbourne), the city has relegated new apartments to a tiny number of "activity centres" on the city's most polluted, noisy, and dangerous streets. Meanwhile, the best blocks of landâ€”those located near public transport on quieter side streets- have been locked up under restrictive zoning and overlays, enforced by local governments on behalf of their most wealthy residents. 

Developers are happy because they can more easily buy up the small number of developable plots. And rich NIMBYs are also happy because their assets are protected. But this status quo is inequitable, and it's making our city a worse place to live. 

For Melbourne to remain a city that values the quality of life of its residents, we need to permit gentle density across all of its most amenity-rich and productive regions, enabling new human-scale homes to be built in areas where people want to live. People should not be restricted to a handful of arbitrarily-defined activity centres. Rather, they should be able to live across the entirety of the city, within an interconnected network of 20-minute neighbourhoods across all 1,992 of Melbourne's tram stops and train stations.

Melbourne already has a plan to fix its missing middle: _[YIMBY Melbourne's Missing Middle](http://yimby.melbourne/missing-middle)_, which lays out the overwhelming evidence of densification's social, environmental, and affordability benefits. 

This report aims to codify these benefits by outlining a new housing delivery paradigm across the 19 inner-city Melbourne councils where demand for denser living is highest. 

YIMBY Melbourne's missing middle reforms will introduce [fairer missing middle zoning](#report-link), underpinned by [enforced housing targets](#report-link) for [each local council](#report-link), ensuring that abundant housing is created city-wide, and for everyone.

### Planning for a better Melbourne

YIMBY Melbourne's plan for a better Melbourne involves four key steps:

1. Upzone inner-middle Melbourne, increasing zoned capacity by `r multiplier` to `r total_zoned_capacity` homes
2. Publish annual housing targets for the 19 LGAs where demand for in-fill housing is greatest
3. Enforce housing targets through revenue-neutral 'carrot and stick' incentives
4. Deliver 40,000 new homes per year across inner and middle Melbourne

### Annual housing targets

YIMBY Melbourne's evidence based housing targets set the realistic number of homes that LGAs can build each year with the help of Missing Middle Zoning. Each council area's target has been carefully calculated based on real-world information on how much land is available for development in each LGA, coupled with land costs, apartment prices, and construction costs. The full methodology to our targets is available under [Calculating targets](inner-city-housing-targets.html#calculating-targets).


```{r,fig.height=7,fig.width = 8}
map_data <- strayr::read_absmap("lga2022") %>% 
  filter(state_name_2021 == "Victoria") %>% 
    mutate(lga_name_2022 = str_remove_all(lga_name_2022, "\\s*\\(.*?\\)\\s*")) %>% 
    mutate(lga_name_2022 = if_else(lga_name_2022 == "Moreland","Merri-bek",lga_name_2022)) %>%  # Moreland changed name in 2021
  inner_join(lga_zoning_numbers) 

if(Sys.info()[[1]] == "Linux") {map_font_size = 22; map_lineheight = .15} else {map_font_size = 2; map_lineheight = 1}


#devtools::install_github("yutannihilation/ggsflabel")
map_data %>% 
  mutate(target = paste0(lga_name_2022,"\n",
                         prettyNum(round(mm_target,-2),
                                   big.mark = ","),
                         " homes")
         ) %>% 
  ggplot()+
  geom_sf(colour = yimby_colours$green_palette[4])+
  ggsflabel::geom_sf_label_repel(aes(label = target ),
                                 size = map_font_size,
                                 lineheight = map_lineheight,
                                 fill = yimby_colours$background)+
    labs(x = element_blank(),
         y = element_blank(),
         title = "Annual council area housing targets") +
  theme_yimby_mel_caption(text_size = "small",plot_type = "map")+
  theme(plot.margin = margin(2, 15,2, 15))+
  theme(panel.background = element_rect(fill = "transparent", colour = NA),  
        plot.background = element_rect(fill = "transparent", colour = NA))

```

```{r}
tbl_body  <- lga_zoning_numbers %>% 
  select(`Council` = lga_name_2022,
         `Existing homes` = existing_dwellings,
         `Current zoned capacity for new housing` = zoned_capacity,
         #`(Excluding heritage)` = zoned_capacity_heritage,
         `New zoned capacity under Missing Middle` = mm_zoned_capacity,
         `Increase in zoned capacity` = change_to_zoned_capacity,
         `Yearly housing target` = mm_target) %>% 
  arrange(desc(`Increase in zoned capacity` ))

total = tbl_body %>% 
  summarise(`Current zoned capacity for new housing` = sum(`Current zoned capacity for new housing`),
            `Existing homes` = sum(`Existing homes`),
            `New zoned capacity under Missing Middle` = sum(`New zoned capacity under Missing Middle`),
            `Yearly housing target` = sum(`Yearly housing target`)) %>% 
  mutate(`Increase in zoned capacity` = `New zoned capacity under Missing Middle`/`Current zoned capacity for new housing`,
         `Council` = "Total")

# tbl_body %>%
#  mutate( `Increase in zoned capacity` = paste0(round(`Increase in zoned capacity`,1),"x")) %>% 
#  gt() %>% 
#  fmt_number(c(`Current zoned capacity for new housing`,
#               `New zoned capacity under Missing Middle`),n_sigfig = 3) %>% 
#  summary_rows(total) %>%
#tab_options(
#    table.background.color = yimby_colours$background, # Change "lightblue" to any color you prefer
#    table.align = "right",
#    ihtml.active = TRUE,
#    ihtml.use_sorting = TRUE,
#    ihtml.use_pagination = FALSE,
#    ihtml.use_pagination_info = FALSE,
#  ) %>% 
#    tab_style(
#    style = list(
#      cell_text(weight = "bold")
#    ),
#    locations = cells_body(
#      rows = everything() %>% tail(1)
#    )
#  )
```

```{r}

# TODO: format the numbers please

total = tbl_body %>% 
  summarise(`Current zoned capacity for new housing` = sum(`Current zoned capacity for new housing`),
            `New zoned capacity under Missing Middle` = sum(`New zoned capacity under Missing Middle`),
            `Yearly housing target` = sum(`Yearly housing target`),
            `Existing homes` = sum(`Existing homes`)
            ) %>% 
  mutate(`Increase in zoned capacity` = paste0(round(`New zoned capacity under Missing Middle`/`Current zoned capacity for new housing`,1),"x"),
         `Council` = "Total") %>% 
  mutate(`Current zoned capacity for new housing`  = prettyNum(round(`Current zoned capacity for new housing`,-3),big.mark = ","),
         `New zoned capacity under Missing Middle`  = prettyNum(round(`New zoned capacity under Missing Middle`,-3),big.mark = ","),
         `Existing homes` = prettyNum(`Existing homes`,big.mark = ","),
         `Yearly housing target` = prettyNum(round(`Yearly housing target`,-2),big.mark = ","),
         )

test_footer <- matrix(0, nrow=1, ncol=6)
colnames(test_footer) <- c('Total', total[1, 4],total[1, 1], total[1, 2], total[1, 5],total[1, 3])

summary_table = htmltools::withTags(table(
  id="summary-table",
  tableHeader(tbl_body),
  tableFooter(test_footer)
))


tbl_body %>% 
  mutate(across(c(`Current zoned capacity for new housing`,`New zoned capacity under Missing Middle`),~round(.x,-3)),
across(c(`Yearly housing target`,`Existing homes`),~round(.x,-2))) %>%
datatable(
  container = summary_table,
  options = list(dom = 't',
                 pageLength = 20
                 ),
  rownames = FALSE
) %>% 
  formatRound(columns = c(2,3,4,6), mark = ',',digits = 0) %>% 
  formatCurrency(columns = c(5), digits = 1,currency = "x", before = F)

```

