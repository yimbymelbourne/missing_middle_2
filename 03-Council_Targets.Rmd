# Housing targets 2024-25

```{r}
tbl_body  <- lga_zoning_numbers %>% 
  select(`Council` = lga_name_2022,
         `Existing homes` = existing_dwellings,
         `Current zoned capacity for new housing` = zoned_capacity,
         #`(Excluding heritage)` = zoned_capacity_heritage,
         `New zoned capacity under Missing Middle` = mm_zoned_capacity,
         `Increase in zoned capacity` = change_to_zoned_capacity,
         `Yearly housing target` = mm_target) %>% 
  arrange(desc(`Increase in zoned capacity` ))

total = tbl_body %>% 
  summarise(`Current zoned capacity for new housing` = sum(`Current zoned capacity for new housing`),
            `Existing homes` = sum(`Existing homes`),
            `New zoned capacity under Missing Middle` = sum(`New zoned capacity under Missing Middle`),
            `Yearly housing target` = sum(`Yearly housing target`)) %>% 
  mutate(`Increase in zoned capacity` = `New zoned capacity under Missing Middle`/`Current zoned capacity for new housing`,
         `Council` = "Total")

# tbl_body %>%
#  mutate( `Increase in zoned capacity` = paste0(round(`Increase in zoned capacity`,1),"x")) %>% 
#  gt() %>% 
#  fmt_number(c(`Current zoned capacity for new housing`,
#               `New zoned capacity under Missing Middle`),n_sigfig = 3) %>% 
#  summary_rows(total) %>%
#tab_options(
#    table.background.color = yimby_colours$background, # Change "lightblue" to any color you prefer
#    table.align = "right",
#    ihtml.active = TRUE,
#    ihtml.use_sorting = TRUE,
#    ihtml.use_pagination = FALSE,
#    ihtml.use_pagination_info = FALSE,
#  ) %>% 
#    tab_style(
#    style = list(
#      cell_text(weight = "bold")
#    ),
#    locations = cells_body(
#      rows = everything() %>% tail(1)
#    )
#  )
```

```{r}
tbl_body <- lga_zoning_numbers %>%
  select(`Council` = lga_name_2022,
         `Existing homes` = existing_dwellings,
         `Current zoned capacity for new housing` = zoned_capacity,
         `New zoned capacity under Missing Middle` = mm_zoned_capacity,
         `Increase in zoned capacity` = change_to_zoned_capacity,
         `Yearly housing target` = mm_target) %>%
  arrange(desc(`Increase in zoned capacity`)) %>%
  mutate(`Council` = paste0('<a href="', tolower(gsub(" ", "-", `Council`)), '.html">', `Council`, '</a>'))

total = tbl_body %>%
  summarise(`Current zoned capacity for new housing` = sum(`Current zoned capacity for new housing`),
            `Existing homes` = sum(`Existing homes`),
            `New zoned capacity under Missing Middle` = sum(`New zoned capacity under Missing Middle`),
            `Yearly housing target` = sum(`Yearly housing target`)) %>%
  mutate(`Increase in zoned capacity` = `New zoned capacity under Missing Middle` / `Current zoned capacity for new housing`,
         `Council` = "Total")

footer_values <- c(
  prettyNum(total$`Existing homes`, big.mark = ","),
  prettyNum(round(total$`Current zoned capacity for new housing`, -3), big.mark = ","),
  prettyNum(round(total$`New zoned capacity under Missing Middle`, -3), big.mark = ","),
  paste0(round(total$`Increase in zoned capacity`, 1), "x"),
  prettyNum(round(total$`Yearly housing target`, -2), big.mark = ",")
)

html_table <- htmltools::HTML(
  paste0(
    '<table id="summary-table">',
    '<thead><tr><th>', paste(lapply(names(tbl_body), htmltools::htmlEscape), collapse = '</th><th>'), '</th></tr></thead>',
    '<tfoot><tr><th>Total</th><th>', paste(lapply(footer_values, htmltools::htmlEscape), collapse = '</th><th>'), '</th></tr></tfoot>',
    '</table>'
  )
)

tbl_body %>%
  mutate(across(c(`Current zoned capacity for new housing`, `New zoned capacity under Missing Middle`), ~ round(.x, -3)),
         across(c(`Yearly housing target`, `Existing homes`), ~ round(.x, -2))) %>%
  datatable(
    container = as.character(html_table),
    options = list(dom = 't', pageLength = 20),
    rownames = FALSE,
    escape = FALSE
  ) %>%
  formatRound(columns = c(2, 3, 4, 6), mark = ',', digits = 0) %>%
  formatCurrency(columns = c(5), digits = 1, currency = "x", before = F)
```